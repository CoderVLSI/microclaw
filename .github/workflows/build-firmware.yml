name: Build ESP32 Firmware

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Cache PlatformIO
      uses: actions/cache@v4
      with:
        path: |
          ~/.platformio
          .pio/build
        key: ${{ runner.os }}-pio-${{ hashFiles('**/lockfiles') }}

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install PlatformIO
      run: |
        pip install platformio
        platformio update

    - name: Create dummy .env for build
      run: |
        cd wroom_brain_pio
        cat > .env << 'ENV_EOF'
        WIFI_SSID=dummy
        WIFI_PASS=dummy
        TELEGRAM_BOT_TOKEN=dummy
        TELEGRAM_ALLOWED_CHAT_ID=123
        LLM_PROVIDER=none
        ENV_EOF

    - name: Build Firmware
      run: |
        cd wroom_brain_pio
        platformio run

    - name: Copy firmware artifacts
      run: |
        mkdir -p artifacts
        cp wroom_brain_pio/.pio/build/esp32dev/firmware.bin artifacts/timiclaw-firmware.bin
        cp wroom_brain_pio/.pio/build/esp32dev/spiffs.bin artifacts/timiclash-spiffs.bin 2>/dev/null || true

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: artifacts/

    - name: Create Release (on push to main)
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: latest
        name: Latest Firmware
        files: |
          artifacts/timiclaw-firmware.bin
          artifacts/timiclash-spiffs.bin
        body: |
          ## Latest TimiClaw Firmware

          ### How to Flash from Termux/Mobile:
          ```bash
          # Download firmware
          wget https://github.com/CoderVLSI/Timiclaw/releases/download/latest/timiclaw-firmware.bin

          # Flash with espflash
          espflash flash timiclaw-firmware.bin

          # Or OTA (if already running):
          # espflash flash --monitor timiclaw-firmware.bin
          ```

          ### What's New:
          - Auto-built from commit: ${{ github.sha }}
          - Built at: ${{ github.event.head_commit.timestamp }}

          ### Manual Flash (USB):
          ```bash
          platformio run -t upload
          ```
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
